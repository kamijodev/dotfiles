#!/bin/bash
OUTPUT="/tmp/gcal-today-events.json"
GCALCLI=/home/emacs/.asdf/installs/python/3.14.3t/bin/gcalcli
PYTHON=/home/emacs/.asdf/installs/python/3.14.3t/bin/python3

TMPFILE=$(mktemp)
ERRFILE=$(mktemp)
trap 'rm -f "$TMPFILE" "$ERRFILE"' EXIT

$GCALCLI \
  --calendar "(上條) HapInS" \
  --calendar "f.kamijodev@gmail.com" \
  agenda "today" "tomorrow" --nodeclined --military --tsv >"$TMPFILE" 2>"$ERRFILE"

if grep -q "invalid_grant\|Token has been expired\|RefreshError" "$ERRFILE"; then
    echo '{"error":"auth_expired"}' > "$OUTPUT"
    exit 1
fi

$PYTHON -c "
import sys, json

seen = set()
events = []
for i, line in enumerate(sys.stdin):
    if i == 0: continue
    parts = line.rstrip().split('\t')
    if len(parts) < 5: continue
    sd, st, ed, et, title = parts[:5]
    if not st or title in ('Busy',): continue
    key = (st, et, title)
    if key in seen: continue
    seen.add(key)
    events.append({'title': title, 'start': st, 'end': et})
print(json.dumps(events))
" < "$TMPFILE" > "$OUTPUT"
